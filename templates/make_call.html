<!DOCTYPE html>
<html>
<head>
    <title>Make Outgoing Call</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .call-entry {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .call-entry input {
            margin-right: 10px;
        }
        .call-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .remove-btn {
            background-color: #f44336;
            margin-left: 10px;
        }
        .remove-btn:hover {
            background-color: #d32f2f;
        }
        .call-history {
            margin-top: 30px;
        }
        .call-history table {
            width: 100%;
            border-collapse: collapse;
        }
        .call-history th, .call-history td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .call-history th {
            background-color: #f2f2f2;
        }
        .call-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-completed {
            background-color: #4CAF50;
            color: white;
        }
        .status-failed {
            background-color: #f44336;
            color: white;
        }
        .status-in-progress {
            background-color: #2196F3;
            color: white;
        }
        .status-pending {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Make Outgoing Calls</h1>
    
    <div class="form-group">
        <label for="trigger-audio">Upload Trigger Audio File (optional):</label>
        <input type="file" id="trigger-audio" name="trigger-audio" accept="audio/*">
        <small>This audio will be played to trigger the AI to speak when the call connects</small>
    </div>
    
    <h2>Phone Numbers and Names</h2>
    <div id="call-list" class="call-list">
        <div class="call-entry">
            <input type="text" class="phone" placeholder="+972123456789" required>
            <input type="text" class="name" placeholder="Recipient name">
            <button class="remove-btn" onclick="removeEntry(this)">Remove</button>
        </div>
    </div>
    
    <button onclick="addNewEntry()">Add Another Number</button>
    <button onclick="makeCall()">Start Calls</button>
    
    <div id="result" class="result" style="display: none;">
        <h3>Current Call</h3>
        <p id="current-call-info">No active call</p>
        <div id="call-controls" style="display: none;">
            <button id="terminate-call-btn" onclick="terminateCurrentCall()" style="background-color: #f44336;">Terminate Call</button>
        </div>
    </div>
    
    <div class="call-history">
        <h2>Call History</h2>
        <button id="clear-queue-btn" onclick="clearCallQueue()" style="background-color: #ff9800; margin-bottom: 10px;">Clear Call Queue</button>
        <table id="call-history-table">
            <thead>
                <tr>
                    <th>Phone</th>
                    <th>Name</th>
                    <th>Start Time</th>
                    <th>Duration</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="call-history-body">
                <!-- Call history will be populated here -->
            </tbody>
        </table>
    </div>
    
    <!-- Modal for viewing transcript -->
    <div id="transcript-modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px;">
            <span style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="document.getElementById('transcript-modal').style.display='none'">&times;</span>
            <h2>Call Transcript</h2>
            <div id="transcript-content" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; padding: 10px; background-color: #f5f5f5;">
                <!-- Transcript will be displayed here -->
            </div>
        </div>
    </div>
    
    <script>
        // Store call queue and history
        const callQueue = [];
        const callHistory = [];
        let currentCall = null;
        let triggerAudioBase64 = null;
        
        // Handle file upload and conversion to base64
        document.getElementById('trigger-audio').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const bytes = new Uint8Array(arrayBuffer);
                    let binary = '';
                    for (let i = 0; i < bytes.byteLength; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    triggerAudioBase64 = btoa(binary);
                    console.log('Audio file loaded and converted to base64');
                };
                reader.readAsArrayBuffer(file);
            }
        });
        
        function addNewEntry() {
            const callList = document.getElementById('call-list');
            const newEntry = document.createElement('div');
            newEntry.className = 'call-entry';
            newEntry.innerHTML = `
                <input type="text" class="phone" placeholder="+972123456789" required>
                <input type="text" class="name" placeholder="Recipient name">
                <button class="remove-btn" onclick="removeEntry(this)">Remove</button>
            `;
            callList.appendChild(newEntry);
        }
        
        function removeEntry(button) {
            const entry = button.parentNode;
            entry.parentNode.removeChild(entry);
        }
        
        function populateCallQueue() {
            callQueue.length = 0; // Clear existing queue
            
            const entries = document.querySelectorAll('.call-entry');
            entries.forEach(entry => {
                const phone = entry.querySelector('.phone').value.trim();
                const name = entry.querySelector('.name').value.trim();
                
                if (phone) {
                    callQueue.push({
                        phone: phone,
                        name: name || 'Unknown',
                        status: 'pending'
                    });
                }
            });
            
            return callQueue.length > 0;
        }
        
        function updateCallHistory() {
            const tableBody = document.getElementById('call-history-body');
            tableBody.innerHTML = '';
            
            callHistory.forEach(call => {
                const row = document.createElement('tr');
                
                // Format duration
                let durationText = 'N/A';
                if (call.duration !== undefined) {
                    durationText = `${call.duration} seconds`;
                }
                
                // Determine status class
                let statusClass = '';
                if (call.status === 'completed') statusClass = 'status-completed';
                else if (call.status === 'failed') statusClass = 'status-failed';
                else if (call.status === 'in-progress') statusClass = 'status-in-progress';
                else if (call.status === 'pending') statusClass = 'status-pending';
                
                // Add transcript button only if we have callSid and the call was connected
                let actionsHtml = '';
                if (call.callSid && (call.status === 'completed' || call.status === 'in-progress')) {
                    actionsHtml = `<button class="view-transcript-btn" onclick="viewTranscript('${call.callSid}')">View Transcript</button>`;
                }
                
                row.innerHTML = `
                    <td>${call.phone}</td>
                    <td>${call.name}</td>
                    <td>${call.startTime || 'N/A'}</td>
                    <td>${durationText}</td>
                    <td><span class="call-status ${statusClass}">${call.status}</span></td>
                    <td>${actionsHtml}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function updateCurrentCallInfo() {
            const infoElement = document.getElementById('current-call-info');
            if (currentCall) {
                infoElement.innerHTML = `
                    <p><strong>Calling:</strong> ${currentCall.name} (${currentCall.phone})</p>
                    <p><strong>Status:</strong> ${currentCall.status}</p>
                    <p><strong>Started at:</strong> ${currentCall.startTime || 'Not started yet'}</p>
                `;
                document.getElementById('result').style.display = 'block';
                
                // Show call controls if there's an active call with a SID
                if (currentCall.callSid && currentCall.status === 'in-progress') {
                    document.getElementById('call-controls').style.display = 'block';
                } else {
                    document.getElementById('call-controls').style.display = 'none';
                }
            } else {
                infoElement.innerHTML = 'No active call';
                if (callQueue.length === 0 && callHistory.length > 0) {
                    infoElement.innerHTML = 'All calls completed';
                }
                document.getElementById('call-controls').style.display = 'none';
            }
        }
        
        function processNextCall() {
            if (callQueue.length === 0) {
                currentCall = null;
                updateCurrentCallInfo();
                return;
            }
            
            currentCall = callQueue.shift();
            currentCall.status = 'in-progress';
            currentCall.startTime = new Date().toLocaleTimeString();
            callHistory.push(currentCall);
            
            updateCallHistory();
            updateCurrentCallInfo();
            
            makeIndividualCall(currentCall);
        }
        
        async function makeIndividualCall(callData) {
            try {
                const formData = new FormData();
                formData.append('phone_number', callData.phone);
                formData.append('recipient_name', callData.name);
                
                // Get the current URL to use as webhook_url
                const currentURL = window.location.origin;
                formData.append('webhook_url', currentURL);
                
                // Add the trigger audio if present
                if (triggerAudioBase64) {
                    formData.append('trigger_audio', triggerAudioBase64);
                }
                
                const response = await fetch('/make-call', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    callData.callSid = data.call_sid;
                    
                    // Start polling for call status
                    pollCallStatus(callData.callSid);
                } else {
                    callData.status = 'failed';
                    updateCallHistory();
                    updateCurrentCallInfo();
                    
                    // Move to next call after a short delay
                    setTimeout(processNextCall, 1000);
                }
            } catch (error) {
                callData.status = 'failed';
                updateCallHistory();
                updateCurrentCallInfo();
                
                // Move to next call after a short delay
                setTimeout(processNextCall, 1000);
            }
        }
        
        async function pollCallStatus(callSid) {
            try {
                const response = await fetch(`/call-status?call_sid=${callSid}`);
                const data = await response.json();
                
                if (currentCall && currentCall.callSid === callSid) {
                    if (data.status === 'completed' || data.status === 'failed' || data.status === 'busy' || data.status === 'no-answer') {
                        currentCall.status = data.status === 'completed' ? 'completed' : 'failed';
                        currentCall.duration = data.duration;
                        updateCallHistory();
                        updateCurrentCallInfo();
                        
                        // Process next call after a short delay
                        setTimeout(processNextCall, 1000);
                    } else {
                        // Continue polling
                        setTimeout(() => pollCallStatus(callSid), 3000);
                    }
                }
            } catch (error) {
                console.error('Error polling call status:', error);
                // Continue polling despite errors
                setTimeout(() => pollCallStatus(callSid), 5000);
            }
        }
        
        async function makeCall() {
            if (!populateCallQueue()) {
                alert('Please enter at least one valid phone number');
                return;
            }
            
            // Reset call history for a new batch
            if (currentCall === null) {
                callHistory.length = 0;
            }
            
            // Start processing calls if not already in progress
            if (!currentCall) {
                processNextCall();
            }
        }
        
        async function terminateCurrentCall() {
            if (!currentCall || !currentCall.callSid) return;
            
            try {
                const formData = new FormData();
                formData.append('call_sid', currentCall.callSid);
                
                const response = await fetch('/terminate-call', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Update call status
                    currentCall.status = 'completed';
                    updateCallHistory();
                    updateCurrentCallInfo();
                    
                    // Process next call after a short delay
                    setTimeout(processNextCall, 1000);
                } else {
                    alert(`Error terminating call: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error terminating call:', error);
                alert('Failed to terminate call. See console for details.');
            }
        }
        
        async function clearCallQueue() {
            // Clear local queue
            if (callQueue.length > 0) {
                if (!confirm(`Are you sure you want to clear ${callQueue.length} queued calls?`)) {
                    return;
                }
                
                callQueue.length = 0;
                alert('Call queue cleared');
            }
            
            // Also clear Twilio queue via API
            try {
                const response = await fetch('/clear-call-queue', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log(`Cleared ${data.message}`);
                } else {
                    console.error(`Error clearing call queue: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error clearing call queue:', error);
            }
        }
        
        async function viewTranscript(callSid) {
            try {
                const response = await fetch(`/call-transcript?call_sid=${callSid}`);
                const data = await response.json();
                
                if (response.ok) {
                    // Display the transcript in the modal
                    const transcriptContent = document.getElementById('transcript-content');
                    
                    if (data.transcript_content) {
                        // If we have the raw transcript content, display it
                        transcriptContent.textContent = data.transcript_content;
                    } else if (data.transcript) {
                        // If we have structured transcript data, format it
                        let formattedTranscript = '';
                        data.transcript.forEach(item => {
                            const role = item.role === 'user' ? 'USER' : 'AI';
                            formattedTranscript += `${role}: ${item.content}\n\n`;
                        });
                        transcriptContent.textContent = formattedTranscript;
                    } else {
                        transcriptContent.textContent = 'No transcript content available.';
                    }
                    
                    // Show the modal
                    document.getElementById('transcript-modal').style.display = 'block';
                } else {
                    alert(`Error fetching transcript: ${data.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error fetching transcript:', error);
                alert('Failed to load transcript. See console for details.');
            }
        }
    </script>
</body>
</html> 